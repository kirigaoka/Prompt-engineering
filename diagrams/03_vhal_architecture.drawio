<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2024-01-01T00:00:00.000Z" agent="Claude" version="22.1.2">
  <diagram id="vhal-arch" name="Vehicle HAL Architecture - Cuttlefish vs Emulator">
    <mxGraphModel dx="1800" dy="1400" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Title -->
        <mxCell id="title" value="&lt;b&gt;Vehicle HAL Architecture Comparison&lt;/b&gt;&lt;br&gt;Source: device/google/cuttlefish &amp; device/generic/goldfish | Automotive Tier-1 SDV Analysis" style="text;html=1;align=center;verticalAlign=middle;fontSize=18;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="200" y="20" width="1200" height="50" as="geometry"/>
        </mxCell>

        <!-- ==================== CUTTLEFISH SIDE (LEFT) ==================== -->
        <mxCell id="cf_title" value="&lt;b&gt;CUTTLEFISH â€” AIDL v3 Vehicle HAL&lt;/b&gt;&lt;br&gt;&lt;i&gt;Production-Grade Architecture&lt;/i&gt;" style="text;html=1;align=center;fontSize=14;fontColor=#1565C0;" vertex="1" parent="1">
          <mxGeometry x="50" y="80" width="700" height="40" as="geometry"/>
        </mxCell>

        <!-- Android Framework Layer -->
        <mxCell id="cf_framework" value="&lt;b&gt;Android AAOS Framework&lt;/b&gt;&lt;br&gt;CarService â†’ CarPropertyManager â†’ VehiclePropertyStore" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1565C0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="130" y="130" width="540" height="50" as="geometry"/>
        </mxCell>

        <!-- AIDL Interface -->
        <mxCell id="cf_aidl" value="&lt;b&gt;IVehicle AIDL v3 Interface&lt;/b&gt;&lt;br&gt;android.hardware.automotive.vehicle&lt;br&gt;@VintfStability" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1565C0;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="200" width="400" height="55" as="geometry"/>
        </mxCell>

        <!-- Arrow Framework to AIDL -->
        <mxCell id="cf_arr1" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#1565C0;strokeWidth=2;" edge="1" parent="1" source="cf_framework" target="cf_aidl">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- DefaultVehicleHal -->
        <mxCell id="cf_default_vhal" value="&lt;b&gt;DefaultVehicleHal&lt;/b&gt;&lt;br&gt;(AOSP reference impl)&lt;br&gt;Handles property subscriptions,&lt;br&gt;batching, access control" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="230" y="280" width="340" height="65" as="geometry"/>
        </mxCell>

        <mxCell id="cf_arr2" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#1565C0;strokeWidth=2;" edge="1" parent="1" source="cf_aidl" target="cf_default_vhal">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- GRPCVehicleHardware -->
        <mxCell id="cf_grpc_hw" value="&lt;b&gt;GRPCVehicleHardware&lt;/b&gt;&lt;br&gt;guest/hals/vehicle/&lt;br&gt;IVehicleHardware implementation&lt;br&gt;gRPC client stub" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="250" y="370" width="300" height="65" as="geometry"/>
        </mxCell>

        <mxCell id="cf_arr3" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#2E7D32;strokeWidth=2;" edge="1" parent="1" source="cf_default_vhal" target="cf_grpc_hw">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Transport Layer -->
        <mxCell id="cf_transport_box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#7B1FA2;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="130" y="460" width="540" height="90" as="geometry"/>
        </mxCell>

        <mxCell id="cf_transport_label" value="&lt;b&gt;Dual Transport Layer&lt;/b&gt;" style="text;html=1;align=center;fontSize=11;fontColor=#7B1FA2;" vertex="1" parent="1">
          <mxGeometry x="300" y="462" width="200" height="20" as="geometry"/>
        </mxCell>

        <mxCell id="cf_vsock" value="&lt;b&gt;VirtIO vsock&lt;/b&gt;&lt;br&gt;CID=VMADDR_CID_HOST&lt;br&gt;Port: vehicle_hal_grpc" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="150" y="485" width="230" height="55" as="geometry"/>
        </mxCell>

        <mxCell id="cf_ethernet" value="&lt;b&gt;Ethernet (Fallback)&lt;/b&gt;&lt;br&gt;192.168.98.1:vehicle_port&lt;br&gt;TAP bridge network" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="420" y="485" width="230" height="55" as="geometry"/>
        </mxCell>

        <mxCell id="cf_arr4" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#F9A825;strokeWidth=2;" edge="1" parent="1" source="cf_grpc_hw" target="cf_transport_box">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- VM Boundary -->
        <mxCell id="cf_vm_boundary" value="" style="shape=line;strokeColor=#D32F2F;strokeWidth=3;dashed=1;dashPattern=8 4;" vertex="1" parent="1">
          <mxGeometry x="50" y="570" width="700" height="10" as="geometry"/>
        </mxCell>
        <mxCell id="cf_vm_label" value="&lt;font color=&quot;#D32F2F&quot;&gt;&lt;b&gt;â•â•â• crosvm VM Boundary (Guest â†‘ | Host â†“) â•â•â•&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=center;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="150" y="558" width="500" height="25" as="geometry"/>
        </mxCell>

        <!-- Host VHAL Server -->
        <mxCell id="cf_host_vhal" value="&lt;b&gt;Host VHAL gRPC Server&lt;/b&gt;&lt;br&gt;VehicleEmulator / VHAL Server&lt;br&gt;host/commands/run_cvd/&lt;br&gt;Processes vehicle property requests" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFECB3;strokeColor=#FF8F00;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="600" width="400" height="65" as="geometry"/>
        </mxCell>

        <mxCell id="cf_arr5" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#7B1FA2;strokeWidth=2;" edge="1" parent="1" source="cf_transport_box" target="cf_host_vhal">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Host Property Store / OEM Extension Point -->
        <mxCell id="cf_oem_ext" value="&lt;b&gt;ðŸ”§ OEM Extension Point&lt;/b&gt;&lt;br&gt;Custom property definitions&lt;br&gt;CAN bus bridging (future)&lt;br&gt;Diagnostic protocols (UDS/OBD)&lt;br&gt;&lt;font color=&quot;#D32F2F&quot;&gt;Tier-1 customization here&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#D32F2F;fontSize=10;dashed=1;dashPattern=4 4;" vertex="1" parent="1">
          <mxGeometry x="200" y="690" width="400" height="75" as="geometry"/>
        </mxCell>

        <mxCell id="cf_arr6" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#FF8F00;strokeWidth=2;" edge="1" parent="1" source="cf_host_vhal" target="cf_oem_ext">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Key Properties Box -->
        <mxCell id="cf_props" value="&lt;b&gt;Supported Vehicle Properties (VehicleProperty.aidl)&lt;/b&gt;&lt;br&gt;INFO_VIN, INFO_MAKE, INFO_MODEL, INFO_FUEL_TYPE&lt;br&gt;PERF_VEHICLE_SPEED, GEAR_SELECTION, HVAC_*&lt;br&gt;DOOR_*, WINDOW_*, SEAT_*, TURN_SIGNAL_STATE&lt;br&gt;EV_BATTERY_LEVEL, FUEL_LEVEL, TIRE_PRESSURE&lt;br&gt;&lt;font color=&quot;#1565C0&quot;&gt;+ Custom OEM properties via vendor namespace&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;fontSize=9;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="790" width="700" height="90" as="geometry"/>
        </mxCell>

        <!-- ==================== EMULATOR SIDE (RIGHT) ==================== -->
        <mxCell id="emu_title" value="&lt;b&gt;EMULATOR â€” No Vehicle HAL&lt;/b&gt;&lt;br&gt;&lt;i&gt;Mobile-First Architecture&lt;/i&gt;" style="text;html=1;align=center;fontSize=14;fontColor=#E65100;" vertex="1" parent="1">
          <mxGeometry x="850" y="80" width="650" height="40" as="geometry"/>
        </mxCell>

        <!-- Emulator Framework -->
        <mxCell id="emu_framework" value="&lt;b&gt;Android Framework (Phone/Tablet)&lt;/b&gt;&lt;br&gt;No CarService, no CarPropertyManager" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="930" y="130" width="480" height="50" as="geometry"/>
        </mxCell>

        <!-- No VHAL -->
        <mxCell id="emu_no_vhal" value="&lt;b&gt;âŒ NO IVehicle Implementation&lt;/b&gt;&lt;br&gt;&lt;br&gt;Goldfish HAL directory contains:&lt;br&gt;audio/, camera/, fingerprint/,&lt;br&gt;gnss/, gralloc/, radio/, sensors/&lt;br&gt;&lt;br&gt;&lt;font color=&quot;#D32F2F&quot;&gt;&lt;b&gt;NO vehicle/ directory exists&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#D32F2F;fontSize=11;dashed=1;dashPattern=8 4;" vertex="1" parent="1">
          <mxGeometry x="960" y="230" width="420" height="140" as="geometry"/>
        </mxCell>

        <mxCell id="emu_arr1" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#E65100;strokeWidth=2;" edge="1" parent="1" source="emu_framework" target="emu_no_vhal">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Emulator transport -->
        <mxCell id="emu_transport" value="&lt;b&gt;goldfish_pipe / QEMU Pipe&lt;/b&gt;&lt;br&gt;Character device for hostâ†”guest IPC&lt;br&gt;Used for sensors, GPS, camera â€” NOT vehicle" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="960" y="420" width="420" height="55" as="geometry"/>
        </mxCell>

        <!-- Emulator VM Boundary -->
        <mxCell id="emu_vm_boundary" value="" style="shape=line;strokeColor=#D32F2F;strokeWidth=3;dashed=1;dashPattern=8 4;" vertex="1" parent="1">
          <mxGeometry x="850" y="570" width="650" height="10" as="geometry"/>
        </mxCell>
        <mxCell id="emu_vm_label" value="&lt;font color=&quot;#D32F2F&quot;&gt;&lt;b&gt;â•â•â• QEMU Process Boundary â•â•â•&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=center;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="950" y="558" width="400" height="25" as="geometry"/>
        </mxCell>

        <!-- QEMU Host -->
        <mxCell id="emu_qemu" value="&lt;b&gt;QEMU Host Process&lt;/b&gt;&lt;br&gt;goldfish_pipe handler&lt;br&gt;No vehicle property emulation&lt;br&gt;No OEM extension mechanism" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="980" y="600" width="380" height="65" as="geometry"/>
        </mxCell>

        <!-- What would be needed box -->
        <mxCell id="emu_needed" value="&lt;b&gt;âš ï¸ To Add VHAL to Emulator:&lt;/b&gt;&lt;br&gt;1. Port entire AIDL v3 IVehicle stack&lt;br&gt;2. Create goldfish_pipe vehicle channel&lt;br&gt;3. Build property store on QEMU host side&lt;br&gt;4. No existing automotive build target&lt;br&gt;&lt;font color=&quot;#D32F2F&quot;&gt;Estimated effort: 6-12 months&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#D32F2F;fontSize=10;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="960" y="700" width="420" height="100" as="geometry"/>
        </mxCell>

        <!-- ==================== SDV Assessment Box ==================== -->
        <mxCell id="sdv_box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8EAF6;strokeColor=#283593;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="50" y="910" width="1450" height="120" as="geometry"/>
        </mxCell>

        <mxCell id="sdv_title" value="&lt;b&gt;ðŸš— Tier-1 SDV Assessment: Vehicle HAL&lt;/b&gt;" style="text;html=1;align=center;fontSize=14;fontColor=#283593;" vertex="1" parent="1">
          <mxGeometry x="500" y="915" width="500" height="25" as="geometry"/>
        </mxCell>

        <mxCell id="sdv_cf" value="&lt;b&gt;âœ… Cuttlefish: RECOMMENDED&lt;/b&gt;&lt;br&gt;â€¢ Full AIDL v3 IVehicle with gRPC extensibility&lt;br&gt;â€¢ Dual transport (vsock + Ethernet) for reliability&lt;br&gt;â€¢ Host-side server enables OEM property injection&lt;br&gt;â€¢ Can bridge to real CAN bus via host gRPC server" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=10;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="70" y="945" width="450" height="75" as="geometry"/>
        </mxCell>

        <mxCell id="sdv_emu" value="&lt;b&gt;âŒ Emulator: NOT VIABLE&lt;/b&gt;&lt;br&gt;â€¢ Zero VHAL support, no automotive build target&lt;br&gt;â€¢ No vehicle property infrastructure at all&lt;br&gt;â€¢ Would require ground-up implementation&lt;br&gt;â€¢ No path to OEM customization" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#D32F2F;fontSize=10;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="540" y="945" width="450" height="75" as="geometry"/>
        </mxCell>

        <mxCell id="sdv_action" value="&lt;b&gt;ðŸŽ¯ Tier-1 Action Items:&lt;/b&gt;&lt;br&gt;1. Extend host gRPC server for OEM props&lt;br&gt;2. Add CAN bus bridge via SocketCAN&lt;br&gt;3. Integrate UDS diagnostic simulator&lt;br&gt;4. Add SOME/IP gateway for service-oriented arch" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=10;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1010" y="945" width="470" height="75" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
